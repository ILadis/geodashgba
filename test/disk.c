
#include <disk.h>
#include "test.h"

static unsigned char bootRecord[] = {
  [447] = 0x82, 0x03, 0x00, 0x0c, 0xfe, 0xff, 0xff, 0x00, 0x20, 0x00, 0x00, 0x00, 0x04, 0xb7, 0x03, 0x00,
  [510] = 0x55, 0xaa
};

static unsigned char superBlock[] = {
  [  0] = 0xeb, 0x00, 0x90, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x02, 0x40, 0x92, 0x04,
          0x02, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x3f, 0x00, 0xff, 0x00, 0x00, 0x20, 0x00, 0x00,
          0x00, 0x04, 0xb7, 0x03, 0xb7, 0x1d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
          0x01, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x80, 0x00, 0x29, 0x63, 0x34, 0x34, 0x33, 0x4e, 0x4f, 0x20, 0x4e, 0x41, 0x4d, 0x45, 0x20, 0x20,
          0x20, 0x20, 0x46, 0x41, 0x54, 0x33, 0x32, 0x20, 0x20, 0x20,
  [510] = 0x55, 0xaa
};

static bool
Disk_ReadStatic(unsigned int index, void *buffer) {
  static unsigned char *sectors[] = {
    [0x0000] = bootRecord,
    [0x2000] = superBlock,
    [0x2492] = NULL, // first FAT
    [0x6000] = NULL, // root DIR
  };

  if (sectors[index] == NULL) {
    return false;
  }

  unsigned char *target = buffer;
  for (int i = 0; i < 512; i++) {
    target[i] = sectors[index][i];
  }

  return true;
}

test(Disk_Initialize_ShouldReadDiskMetadata) {
  // arrange
  Disk disk = {0};
  Disk_ReadFrom(&disk, Disk_ReadStatic);

  // act
  bool result = Disk_Initialize(&disk);

  // assert
  assert(result == true);
  assert(disk.meta.bytesPerSector == 512);
  assert(disk.meta.sectorsPerCluster == 64);
  assert(disk.meta.numberOfReservedSectors == 1170);
  assert(disk.meta.numberOfFATs == 2);
  assert(disk.meta.numberOfSectorsPerFAT == 7607);
  assert(disk.meta.clusterOfRootDir == 2);
}

suite(
  Disk_Initialize_ShouldReadDiskMetadata);